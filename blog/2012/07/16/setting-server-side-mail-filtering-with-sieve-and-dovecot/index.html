
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Setting server-side mail filtering with sieve and dovecot - Igor Rzegocki Personal Homepage</title>
  <meta name="author" content="Igor Rzegocki">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.rzegocki.pl/blog/2012/07/16/setting-server-side-mail-filtering-with-sieve-and-dovecot">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Igor Rzegocki Personal Homepage" type="application/atom+xml">
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/bootstrap-collapse.js"></script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/">About me</a></li>
    
        <li ><a href="/portfolio">Portfolio</a></li>
    
        <li ><a href="/open-source">Open source</a></li>
    
        <li ><a href="/blog">Blog</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/ajgon" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    
    <li><a href="http://twitter.com/ajgon" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    
    
    
    <li><a href="/public-key.txt" title="GPG Key"><i class="icon-key social-navbar"></i></a></li>
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    Setting Server-side Mail Filtering With Sieve and Dovecot
	<h5>








  


<i class="icon-calendar-empty"></i> <time datetime="2012-07-16T11:43:00+02:00" pubdate data-updated="true">Jul 16<span>th</span>, 2012</time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p>Leaving GMail was of the best decisions for my mail I made recently. But also a
most problematic one. I needed to set all the MTA architecture myself. I tested
many solutions out there and finally ended with postfix + dovecot
configuration.  It appears that this is most stable and unproblematic one (at
least for now).</p>

<!--more-->


<p>The next feature I really missed is Gmail Server-Side mail filtering. I&rsquo;ve got
a bunch of machines that access my mail server (computers, phones etc.) and I
receive lots emails from lists, friends and organizations every day. Setting
filtering for all of that once, was a big pain. Setting it multiple times on
all the machines, and then be consistent about it was enormous P.I.T.A. So I
started looking for solution for that problem and found
<a href="http://sieve.info/">Sieve</a> (and its
<a href="http://wiki.dovecot.org/LDA/Sieve">dovecot plugin</a>).</p>

<p>Ok, so how to do it? Firstly, as for dovecot 1.2.x, sieve was completely
rewritten as a new plugin. It can be obtained from
<a href="http://www.rename-it.nl/dovecot/1.2/">rename-it.nl website</a>. At the time of
writing this post, there is no <code>*.deb</code> package in repositories, so I have to
build it manually. I also had to install <code>dovecot-dev</code> package, because of
sieve configurator, which needs a <code>dovecot-config</code> file.</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>wget http://www.rename-it.nl/dovecot/1.2/dovecot-1.2-sieve-0.1.19.tar.gz
</span><span class='line'>tar -xzvf dovecot-1.2-sieve-0.1.19.tar.gz
</span><span class='line'><span class="nb">cd </span>dovecot-1.2-sieve-0.1.19
</span><span class='line'>./configure --with-dovecot<span class="o">=</span>/usr/lib/dovecot/ --prefix<span class="o">=</span>/usr
</span><span class='line'>make
</span><span class='line'>sudo make install
</span></code></pre></td></tr></table></div></figure>


<p>After that, it was a time to enable sieve plugin in dovecot.</p>

<figure class='code'><figcaption><span>/etc/dovecot/dovecot.conf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>protocol lda <span class="o">{</span>
</span><span class='line'>    ...
</span><span class='line'>    <span class="c"># Support for dynamically loadable plugins. mail_plugins is a space separated</span>
</span><span class='line'>    <span class="c"># list of plugins to load.</span>
</span><span class='line'>    <span class="nv">mail_plugins</span> <span class="o">=</span> sieve <span class="c"># ... other plugins like quota</span>
</span><span class='line'>    <span class="c"># add those directives when you expect problems - huge time saver!</span>
</span><span class='line'>    <span class="nv">debug</span> <span class="o">=</span> yes
</span><span class='line'>    <span class="nv">log_path</span> <span class="o">=</span> /var/log/dovecot-lda.log
</span><span class='line'>    <span class="nv">info_log_path</span> <span class="o">=</span> /var/log/dovecot-lda.log
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is a possibility to make some adjustments for plugin itself (filters
paths and so on), but I didn&rsquo;t find it necessary. However, if you want to &ndash; you
can check them on
<a href="http://wiki.dovecot.org/LDA/Sieve/Dovecot">LDA/Sieve documentation page</a>.
After that, just restart postfix and everything is set.</p>

<p>The last step is setting all the filters properly. They should be stored in
<code>~/.dovecot.sieve</code> (if you use <code>mailbox_command</code>) or in
<code>/home/vmail/user@domain/.dovecot.sieve</code> (if you use <code>mailbox_transport</code>).
Sieve uses it&rsquo;s own <a href="http://www.ietf.org/rfc/rfc5228.txt">pseudo-language</a> for
filtering, but below is a part of my file which should provide a
<a href="http://wiki.dovecot.org/LDA/Sieve/">good example</a> for start:</p>

<figure class='code'><figcaption><span>.dovecot.sieve </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Require plugin for moving messages (fileinto) and vacation responder (vacation)</span>
</span><span class='line'>require <span class="o">[</span><span class="s2">&quot;fileinto&quot;</span>, <span class="s2">&quot;vacation&quot;</span><span class="o">]</span>;
</span><span class='line'>
</span><span class='line'><span class="c"># Move all mails with &quot;List-Id&quot; equal to &quot;users-pl.lists.rootnode.net&quot; to rzegocki_pl/lists IMAP directory</span>
</span><span class='line'><span class="k">if </span>header :contains <span class="s2">&quot;List-Id&quot;</span> <span class="s2">&quot;users-pl.lists.rootnode.net&quot;</span> <span class="o">{</span> fileinto <span class="s2">&quot;rzegocki_pl.lists&quot;</span>; stop; <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># If messages are not from a list (most of the lists sets mail header &quot;Precedence&quot; either to &quot;list&quot; or &quot;bulk&quot;) then send a vacation email</span>
</span><span class='line'><span class="k">if </span>not header :contains <span class="s2">&quot;Precedence&quot;</span> <span class="o">[</span><span class="s2">&quot;bulk&quot;</span>,<span class="s2">&quot;list&quot;</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>    vacation :days 7 :addresses <span class="o">[</span><span class="s2">&quot;igor@email1.com&quot;</span>, <span class="s2">&quot;igor@email2.com&quot;</span><span class="o">]</span> :subject <span class="s2">&quot;Vacation 15.07 - 22.07&quot;</span> <span class="s2">&quot; ..... &quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Move all messages from my father to one directory</span>
</span><span class='line'><span class="k">if </span>anyof <span class="o">(</span>
</span><span class='line'>    address :is <span class="s2">&quot;sender&quot;</span> <span class="s2">&quot;steven@email1.com&quot;</span>,
</span><span class='line'>    address :is <span class="s2">&quot;sender&quot;</span> <span class="s2">&quot;steven@email2.com&quot;</span>,
</span><span class='line'>    address :is <span class="s2">&quot;sender&quot;</span> <span class="s2">&quot;steven@email3.com&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        fileinto <span class="s2">&quot;rzegocki_pl.private.steven&quot;</span>; stop;
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It took me some time to set everything up (mostly because of lack of
documentation and multiple domain problems), but the final effect is awesome,
and confirms that own server is an really, really great idea :)</p>

    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/blog/categories/Administration/"><span class="badge">Administration</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <p class="meta">
          
          
            <a class="basic-alignment right" href="/blog/2012/07/21/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup/" title="Next Post: Adding a little bit of SpamAssassin into Postfix/Dovecot/Sieve soup">Adding a little bit of SpamAssassin into Postfix/Dovecot/Sieve soup &raquo;</a>
          
        </p>
      </div>
    </div>
  </footer>
</article>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2013 - Igor Rzegocki -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>. Old version of the site, available <a href="/v1">here</a>.
</p>


        </footer>
      </div>
    </div>
  </div>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
