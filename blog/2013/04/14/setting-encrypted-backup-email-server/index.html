
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Setting encrypted backup Email server - Igor Rzegocki Personal Homepage</title>
  <meta name="author" content="Igor Rzegocki">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.rzegocki.pl/blog/2013/04/14/setting-encrypted-backup-email-server">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Igor Rzegocki Personal Homepage" type="application/atom+xml">
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/bootstrap-collapse.js"></script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/html5shiv.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/">About me</a></li>
    
        <li ><a href="/portfolio">Portfolio</a></li>
    
        <li ><a href="/open-source">Open source</a></li>
    
        <li ><a href="/blog">Blog</a></li>
    
</ul>

<ul class="nav pull-right">
    
    
    <li><a href="http://github.com/ajgon" title="Github Profile"><i class="icon-github-sign social-navbar"></i> <span>GitHub</span></a></li>
    
    
    <li><a href="http://linkedin.com/in/ajgon" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i> <span>LinkedIn</span></a></li>
    
    
    <li><a href="http://twitter.com/ajgon" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i> <span>Twitter</span></a></li>
    
    
    
    <li><a href="http://facebook.com/7d7cdc4a42dd7aa15f891c7314db770a02efe0e7" title="Facebook Profile"><i class="icon-facebook-sign social-navbar"></i> <span>Facebook</span></a></li>
    
    
    <li><a href="mailto:igor@rzegocki.pl" title="Email"><i class="icon-envelope-alt social-navbar"></i> <span>E-mail</span></a></li>
    
    
    <li><a href="/public-key.txt" title="GPG Key"><i class="icon-key social-navbar"></i> <span>GPG Key</span></a></li>
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    Setting Encrypted Backup Email Server
	<h5>








  


<i class="icon-calendar-empty"></i> <time datetime="2013-04-14T13:34:00+02:00" pubdate data-updated="true">Apr 14<span>th</span>, 2013</time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p>There is a popular Internet saying that people are divided into two groups &ndash;
those who make backups, and those who will. I strongly believe into that,
that&rsquo;s why despite that I trust my mailserver setup completely, I still want to
keep them in some other safe place. Probably somewhere, where somebody else
takes care of everything :) That&rsquo;s why I chose
<a href="http://mail.zoho.com/">ZOHO MAIL</a> as my backup server.</p>

<!--more-->


<p>Mostly for three reasons:</p>

<ul>
<li>They have IMAP</li>
<li>They have enough space for free</li>
<li>They also provide a nice webmail</li>
</ul>


<p>So my next task was to configure postfix in a way, that it will deliver all the
messages as it does currently, but also forward them to zoho.com. Of course I
wasn&rsquo;t THAT crazy, to send my private emails over the Internet as they are, so
I also needed some kind of encryption before that. It appeared that somebody
had the same problem, and there is a tool for that called
<a href="http://code.google.com/p/gpg-mailgate/">gpg-mailgate</a>. Unfortunately it&rsquo;s a
very unfinished application, and lots of things doesn&rsquo;t work (multipart
messages support, attachmenets encryption, extra email encryption and so on),
so I needed to do
<a href="https://github.com/ajgon/gpg-mailgate">a little bit of extra hacking</a>. And I
strongly recommend you, to use my version if you thinking about encrypting your
email out of the box. Ok, that&rsquo;s for the beginning &ndash; let&rsquo;s do some
configuration!</p>

<h2>Setting gpg</h2>

<p>First thing is to install and configure a gpg account. I strongly recommend to
not to use your gpg keys (if you already have some), but create new, clean key.
Also, we need a new user in the file system for postfix to handle key support.
Lastly, gpg-mailgate comes with a Python library, which also needs to be
installed.</p>

<p>Install GPG:</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install gpg
</span></code></pre></td></tr></table></div></figure>


<p>Create a gpg user and give him the key (don&rsquo;t forget to disable the password,
and set trust to ultimate &ndash; otherwise tour scripts will stop to ask about
confirmation &ndash; and eventually fail):</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>useradd -s /bin/false -d /var/gpg -M gpgmap
</span><span class='line'>mkdir -p /var/gpg/.gnupg
</span><span class='line'>chown -R gpgmap /var/gpg
</span><span class='line'>chmod 700 /var/gpg/.gnupg
</span><span class='line'>sudo -u gpgmap /usr/bin/gpg --gen-key --homedir<span class="o">=</span>/var/gpg/.gnupg
</span><span class='line'>sudo -u gpgmap gpg --edit-key your@key.email.com trust quit
</span></code></pre></td></tr></table></div></figure>


<h2>Setting gpg-mailgate</h2>

<p>Install GnuPG Python library, and gpg-mailgate itself:</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> /root
</span><span class='line'>git clone https://github.com/ajgon/gpg-mailgate.git
</span><span class='line'><span class="nb">cd </span>gpg-mailgate
</span><span class='line'>cp -R GnuPG /usr/lib/python2.6
</span><span class='line'>cp gpg-mailgate.py /usr/local/bin/gpg-mailgate.py
</span><span class='line'>cp gpg-mailgate.conf.sample /etc/gpg-mailgate.conf
</span></code></pre></td></tr></table></div></figure>


<p>Config file is pretty explanatory &ndash; what you have to change is &ldquo;domains&rdquo;
parameter (put only domains, which you want to receive encrypted messages),
keyhome (set to <code>/var/gpg/.gnupg</code>) and keymap (map all the emails which should
receive encrypted content there &ndash; follow the hint in file). So all in all your
config file should look similar to this:</p>

<figure class='code'><figcaption><span>/etc/gpg-mailgate.conf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[default]</span>
</span><span class='line'><span class="na">add_header</span> <span class="o">=</span> <span class="s">yes</span>
</span><span class='line'><span class="na">domains</span> <span class="o">=</span> <span class="s">zoho.com</span>
</span><span class='line'>
</span><span class='line'><span class="k">[gpg]</span>
</span><span class='line'><span class="na">keyhome</span> <span class="o">=</span> <span class="s">/var/gpg/.gnupg</span>
</span><span class='line'>
</span><span class='line'><span class="k">[logging]</span>
</span><span class='line'><span class="na">file</span> <span class="o">=</span> <span class="s">/tmp/gpg-mailgate.log</span>
</span><span class='line'>
</span><span class='line'><span class="k">[relay]</span>
</span><span class='line'><span class="na">host</span> <span class="o">=</span> <span class="s">127.0.0.1</span>
</span><span class='line'><span class="na">port</span> <span class="o">=</span> <span class="s">10028</span>
</span><span class='line'>
</span><span class='line'><span class="k">[keymap]</span>
</span><span class='line'><span class="na">email.which.will.receive.encrypted.content@zoho.com</span> <span class="o">=</span> <span class="s">123456789ABCDEF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setting postfix</h2>

<p>The last thing is postfix configuration which is (surprisingly) really easy,
just activate content filter in <code>main.cf</code> and add relay to <code>master.cf</code>. One
last thing is to add X-GPG-* headers to tell the script, which extra email
addresses we want to deliver messages encrypted. Normally gpg-mailgate encrypts
only messages to addresses that are configured in gpg-mailgate.conf file and
available in To/Cc/Bcc headers of original message. Unfortunatelly, we are
using a totally different zoho.com email intended only for backups &ndash; it will
never appear in original message headers, because it&rsquo;s not the recipient. To
make it appear &ndash; simply add <code>X-GPG-Encrypt-Cc</code> header to your message. So, the
configuration will present as follows:</p>

<figure class='code'><figcaption><span>/etc/postfix/main.cf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># gpg</span>
</span><span class='line'><span class="nv">header_checks</span> <span class="o">=</span> regexp:/etc/postfix/header_checks
</span><span class='line'><span class="nv">content_filter</span> <span class="o">=</span> gpg-mailgate
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>/etc/postfix/header_checks </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/^From: .*/ PREPEND X-GPG-Encrypt-Cc: email.which.will.receive.encrypted.content@zoho.com</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>/etc/postfix/master.cf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># gpg-mailgate</span>
</span><span class='line'>gpg-mailgate    unix    -       n       n       -       -       pipe
</span><span class='line'>  <span class="nv">flags</span><span class="o">=</span> <span class="nv">user</span><span class="o">=</span>gpgmap <span class="nv">argv</span><span class="o">=</span>/usr/local/bin/gpg-mailgate.py
</span><span class='line'>
</span><span class='line'>127.0.0.1:10028 inet    n       -       n       -       10      smtpd
</span><span class='line'>        -o <span class="nv">content_filter</span><span class="o">=</span>
</span><span class='line'>        -o <span class="nv">receive_override_options</span><span class="o">=</span>no_unknown_recipient_checks,no_header_body_checks
</span><span class='line'>        -o <span class="nv">smtpd_helo_restrictions</span><span class="o">=</span>
</span><span class='line'>        -o <span class="nv">smtpd_client_restrictions</span><span class="o">=</span>
</span><span class='line'>        -o <span class="nv">smtpd_sender_restrictions</span><span class="o">=</span>
</span><span class='line'>        -o <span class="nv">smtpd_recipient_restrictions</span><span class="o">=</span>permit_mynetworks,reject
</span><span class='line'>        -o <span class="nv">mynetworks</span><span class="o">=</span>127.0.0.0/8
</span><span class='line'>        -o <span class="nv">smtpd_authorized_xforward_hosts</span><span class="o">=</span>127.0.0.0/8
</span></code></pre></td></tr></table></div></figure>


<p>Don&rsquo;t forget to create <code>header_checks.db</code> and restart postfix.</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>postmap header_checks
</span><span class='line'>/etc/init.d/postfix restart
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s pretty much everything. Send yourself an email, and enjoy your new,
shiny and secure backup :)</p>

<h3>Sources</h3>

<ul>
<li><a href="http://ultramegaman.wordpress.com/tag/gpg-mailgate/">http://ultramegaman.wordpress.com/tag/gpg-mailgate/</a></li>
</ul>


    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/blog/categories/Administration/"><span class="badge">Administration</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <p class="meta">
          
            <a class="basic-alignment left" href="/blog/2012/10/27/add-more-complexity-to-your-emails-use-dkim-and-spf/" title="Previous Post: Add more complexity to your Emails - use DKIM and SPF">&laquo; Add more complexity to your Emails - use DKIM and SPF</a>
          
          
            <a class="basic-alignment right" href="/blog/2013/10/28/adding-email-server-autoconfig-and-autodiscover/" title="Next Post: Adding Email server autoconfig and autodiscover">Adding Email server autoconfig and autodiscover &raquo;</a>
          
        </p>
      </div>
    </div>
  </footer>
</article>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2015 - Igor Rzegocki -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>. Previous version of the site, available <a href="/v2">here</a>.
</p>


        </footer>
      </div>
    </div>
  </div>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
