
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Adding a little bit of SpamAssassin into Postfix/Dovecot/Sieve soup - Igor Rzegocki Personal Homepage</title>
  <meta name="author" content="Igor Rzegocki">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.rzegocki.pl/blog/2012/07/21/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup">
  <link href="/v3/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/v3/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Igor Rzegocki Personal Homepage" type="application/atom+xml">
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/bootstrap-collapse.js"></script>
  <script src="/v3/javascripts/modernizr-2.0.js"></script>
  <script src="/v3/javascripts/html5shiv.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/v3/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/v3/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/v3/">About me</a></li>
    
        <li ><a href="/v3/portfolio">Portfolio</a></li>
    
        <li ><a href="/v3/open-source">Open source</a></li>
    
        <li ><a href="/v3/papers">Papers</a></li>
    
        <li ><a href="/v3/blog">Blog</a></li>
    
</ul>

<ul class="nav pull-right">
    
    
    <li><a href="http://github.com/ajgon" title="Github Profile"><i class="icon-github-sign social-navbar"></i> <span>GitHub</span></a></li>
    
    
    <li><a href="http://linkedin.com/in/ajgon" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i> <span>LinkedIn</span></a></li>
    
    
    <li><a href="http://twitter.com/ajgon" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i> <span>Twitter</span></a></li>
    
    
    
    <li><a href="http://facebook.com/7d7cdc4a42dd7aa15f891c7314db770a02efe0e7" title="Facebook Profile"><i class="icon-facebook-sign social-navbar"></i> <span>Facebook</span></a></li>
    
    
    <li><a href="mailto:igor@rzegocki.pl" title="Email"><i class="icon-envelope-alt social-navbar"></i> <span>E-mail</span></a></li>
    
    
    <li><a href="/public-key.txt" title="GPG Key"><i class="icon-key social-navbar"></i> <span>GPG Key</span></a></li>
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    Adding a Little Bit of SpamAssassin Into Postfix/Dovecot/Sieve Soup
	<h5>








  


<i class="icon-calendar-empty"></i> <time datetime="2012-07-21T12:16:00+02:00" pubdate data-updated="true">Jul 21<span>st</span>, 2012</time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p>I was always prefering &ldquo;stay in the shadows&rdquo; policy in terms of email address.
I have two secondary emails (for spam I want to read, and for spam I want to be
sent into oblivion i.e. for &ldquo;Register NOW to download this 2KB file&rdquo; sites). My
primary e-mail was well guarded and given only to living people. Until one
company decided to show it to the whole world by putting it into WHOIS database
for my domain. Before I reacted, it was too late. And my little mail server
needed one more extension.</p>

<!--more-->


<p>I wanted to integrate it somehow with my existing configuration &ndash; so, when
message is parsed by spam filter, it needs to be filtered further by sieve.
Thanks to that, I can have full control over spam and even categorize it (yeah,
I&rsquo;m a picky bastard ;)). Thankfully
<a href="http://spamassassin.apache.org/">SpamAssassin</a> can do this, so I didn&rsquo;t have
to look further. I also decided to inlcude
<a href="http://sourceforge.net/apps/trac/pyzor/">Pyzor</a>,
<a href="http://razor.sourceforge.net/">Razor</a> and
<a href="http://www.dcc-servers.net/dcc/">DCC</a>. No mercy!</p>

<h2>Installing packets</h2>

<p>But first &ndash; necessary packets. Thankfully, debian has everything out of box,
except DCC.</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>apt-get install spamc spamassassin pyzor razor
</span></code></pre></td></tr></table></div></figure>


<p>Next is DCC, which has to be build manually:</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>groupadd dcc
</span><span class='line'>useradd -g dcc -s /bin/false -d /var/dcc dcc
</span><span class='line'>wget http://www.dcc-servers.net/dcc/source/dcc-dccproc.tar.Z
</span><span class='line'>tar xzvf dcc-dccproc.tar.Z
</span><span class='line'><span class="nb">cd </span>dcc-dccproc-1.3.142
</span><span class='line'>./configure --with-uid<span class="o">=</span>dcc
</span><span class='line'>make
</span><span class='line'>make install
</span><span class='line'>chown -R dcc:dcc /var/dcc
</span><span class='line'>ln -s /var/dcc/libexec/dccifd /usr/local/bin/dccif
</span></code></pre></td></tr></table></div></figure>


<h2>Setting up SpamAssassin</h2>

<p>The next step is to configure <code>spamd</code> to run as a daemon:</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>groupdd spamd
</span><span class='line'>useradd -g spamd -s /bin/false -d /var/lib/spamassassin spamd
</span><span class='line'>mkdir -p /var/lib/spamassassin
</span><span class='line'>chown spamd:spamd /var/lib/spamassassin -R
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>/etc/default/spamassassin </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Spamassassin home</span>
</span><span class='line'><span class="nv">SAHOME</span><span class="o">=</span><span class="s2">&quot;/var/lib/spamassassin&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Where imap stores user emails</span>
</span><span class='line'><span class="nv">USERACCOUNTS</span><span class="o">=</span><span class="s2">&quot;/home/vmail&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Change to one to enable spamd</span>
</span><span class='line'><span class="nv">ENABLED</span><span class="o">=</span>1
</span><span class='line'>
</span><span class='line'><span class="c"># Options</span>
</span><span class='line'><span class="c"># See man spamd for possible options. The -d option is automatically added.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># SpamAssassin uses a preforking model, so be careful! You need to</span>
</span><span class='line'><span class="c"># make sure --max-children is not set to anything higher than 5,</span>
</span><span class='line'><span class="c"># unless you know what you&#39;re doing.</span>
</span><span class='line'><span class="c"># For -A use the IP address of spamc client (probably IP of primary interface)</span>
</span><span class='line'><span class="nv">OPTIONS</span><span class="o">=</span><span class="s2">&quot;--create-prefs -x --max-children 3 --username spamd --helper-home-dir ${SAHOME} -s ${SAHOME}/spamd.log --virtual-config-dir=${USERACCOUNTS}/%l@%d/spamassassin -A 192.168.1.1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>virtual-config-dir</code> allows us to have separate user preferences and bayes
databases for each virtual user. The next thing is to edit
<code>/etc/spamassassin/local.cf</code> file:</p>

<figure class='code'><figcaption><span>/etc/spamassassin/local.cf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'><span class="c"># Save spam messages as a message/rfc822 MIME attachment instead of</span>
</span><span class='line'><span class="c"># modifying the original message (0: off, 2: use text/plain instead)</span>
</span><span class='line'>report_safe 0
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>use_dcc 1
</span><span class='line'>dcc_path /usr/local/bin/dccproc
</span><span class='line'>
</span><span class='line'>use_pyzor 1
</span><span class='line'>pyzor_path /usr/bin/pyzor
</span><span class='line'>
</span><span class='line'>use_razor2 1
</span><span class='line'>razor_config /etc/razor/razor-agent.conf
</span></code></pre></td></tr></table></div></figure>


<p>Afterwards, edit <code>/etc/spamassassin/v310.pre</code> and check that the DCC, Razor and
Pyzor plugins are enabled (DCC is disabled by default). After that, the only
thing left is to update SA databases and start it:</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sa-update --no-gpg
</span><span class='line'>/etc/init.d/spamassassin start
</span></code></pre></td></tr></table></div></figure>


<h2>Setting up postfix transport</h2>

<p>From the postfix side all you have to do is change transport (I suggest to
create a new one &ndash; then, when something goes wrong you can easily switch back
to old working configuration) or <code>mailbox_command</code>. For transport, the magic
line looks like this:</p>

<figure class='code'><figcaption><span>/etc/postfix/master.cf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>dovecot-spam   unix  -       n       n       -       -       pipe
</span><span class='line'>    <span class="nv">flags</span><span class="o">=</span>DRhu <span class="nv">user</span><span class="o">=</span>vmail:vmail <span class="nv">argv</span><span class="o">=</span>/usr/bin/spamc -u <span class="k">${</span><span class="nv">recipient</span><span class="k">}</span> -e /usr/lib/dovecot/deliver -d <span class="k">${</span><span class="nv">recipient</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this is the line I&rsquo;ve been looking for. SpamAssassin takes message, pushes
it through his intestines, adds headers, and output is pushed further to
<code>deliver</code> command. From that point, it can be taken by Sieve. To make this
work, don&rsquo;t forget to change the transport!</p>

<figure class='code'><figcaption><span>/etc/postfix/main.cf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">mailbox_transport</span> <span class="o">=</span> dovecot-spam
</span></code></pre></td></tr></table></div></figure>


<p>Restart postfix:</p>

<figure class='code'><figcaption><span>As root </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/etc/init.d/postfix restart
</span></code></pre></td></tr></table></div></figure>


<h2>And finally&hellip; Sieve</h2>

<p>After all of that, all you have to do is configure Sieve. For example like that
(<em>Junk</em> is a folder which Thunderbird traditionally uses for spam, you can
change it of course):</p>

<figure class='code'><figcaption><span>.dovecot.sieve </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">if </span>header :contains <span class="s2">&quot;X-Spam-Flag&quot;</span> <span class="o">[</span><span class="s2">&quot;YES&quot;</span><span class="o">]</span> <span class="o">{</span> fileinto <span class="s2">&quot;Junk&quot;</span>; stop; <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To test it, just send an email to protected account and look into the headers.
You should see a SpamAssassin magic added there. To test filtering, use
<a href="http://spamassassin.apache.org/gtube/">GTUBE</a> message format &ndash; your email
should land in Junk.</p>

<h2>Conclusion</h2>

<p>I think this configuration will suit my needs. Probably it will get some
adjustments over time (like intelligent filters in SA and so on), and &ndash; when I
start to trust it fully &ndash; instead of moving into the Junk all spam will be
deleted. But for now, everything works like a charm :) If you experience any
problems, first look into <code>/var/lib/spamassassin/spamd.log</code> file &ndash; there is big
chance, that you&rsquo;ll find your answers there.</p>

<h3>Sources</h3>

<ul>
<li><a href="http://ailoo.net/2009/11/integrate-spamassassin-into-postfix-dovecot/">http://ailoo.net/2009/11/integrate-spamassassin-into-postfix-dovecot/</a></li>
</ul>


    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/v3/blog/categories/Administration/"><span class="badge">Administration</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <p class="meta">
          
            <a class="basic-alignment left" href="/v3/blog/2012/07/16/setting-server-side-mail-filtering-with-sieve-and-dovecot/" title="Previous Post: Setting server-side mail filtering with sieve and dovecot">&laquo; Setting server-side mail filtering with sieve and dovecot</a>
          
          
            <a class="basic-alignment right" href="/v3/blog/2012/09/22/setting-development-environment-on-your-mac/" title="Next Post: Setting development environment on your Mac">Setting development environment on your Mac &raquo;</a>
          
        </p>
      </div>
    </div>
  </footer>
</article>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2015 - Igor Rzegocki -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>. Previous version of the site, available <a href="/v2">here</a>.
</p>


        </footer>
      </div>
    </div>
  </div>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
